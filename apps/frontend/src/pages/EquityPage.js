import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { Container, Title, Text, Stack, Paper, Table, Group, Badge, SimpleGrid, Divider, } from '@mantine/core';
import { useQuery } from '@tanstack/react-query';
import { equityService } from '../services/equity.service';
import { formatCurrency } from '../utils/format';
import { LoadingSpinner } from '../components/ui/LoadingSpinner';
import { SimpleBarChart } from '../components/charts/SimpleBarChart';
export function EquityPage() {
    const { data: equity, isLoading } = useQuery({
        queryKey: ['equity'],
        queryFn: () => equityService.getEquity(),
        refetchInterval: 30000, // Обновление каждые 30 секунд
    });
    if (isLoading) {
        return _jsx(LoadingSpinner, {});
    }
    if (!equity) {
        return (_jsxs(Container, { size: "xl", children: [_jsx(Title, { order: 2, mb: "md", children: "\u0420\u0430\u0441\u043F\u0440\u0435\u0434\u0435\u043B\u0435\u043D\u0438\u0435 \u0434\u043E\u043B\u0435\u0439" }), _jsx(Text, { c: "dimmed", children: "\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0434\u0430\u043D\u043D\u044B\u0435" })] }));
    }
    return (_jsxs(Container, { size: "xl", children: [_jsx(Title, { order: 2, mb: "md", children: "\u0420\u0430\u0441\u043F\u0440\u0435\u0434\u0435\u043B\u0435\u043D\u0438\u0435 \u0434\u043E\u043B\u0435\u0439 \u0432\u043B\u0430\u0434\u0435\u043B\u044C\u0446\u0435\u0432" }), _jsxs(SimpleGrid, { cols: { base: 1, sm: 3 }, mb: "xl", children: [_jsx(Paper, { withBorder: true, p: "md", radius: "md", children: _jsx(Group, { justify: "space-between", children: _jsxs("div", { children: [_jsx(Text, { c: "dimmed", size: "xs", tt: "uppercase", fw: 700, children: "\u041E\u0431\u0449\u0438\u0435 \u0430\u043A\u0442\u0438\u0432\u044B" }), _jsx(Text, { fw: 700, size: "xl", c: "greenCycle", children: formatCurrency(equity.totalAssets) })] }) }) }), _jsx(Paper, { withBorder: true, p: "md", radius: "md", children: _jsx(Group, { justify: "space-between", children: _jsxs("div", { children: [_jsx(Text, { c: "dimmed", size: "xs", tt: "uppercase", fw: 700, children: "\u0414\u0435\u043D\u0435\u0436\u043D\u044B\u0435 \u0430\u043A\u0442\u0438\u0432\u044B" }), _jsx(Text, { fw: 700, size: "xl", c: "blue", children: formatCurrency(equity.cashAssets) })] }) }) }), _jsx(Paper, { withBorder: true, p: "md", radius: "md", children: _jsx(Group, { justify: "space-between", children: _jsxs("div", { children: [_jsx(Text, { c: "dimmed", size: "xs", tt: "uppercase", fw: 700, children: "\u0422\u043E\u0432\u0430\u0440\u044B \u043D\u0430 \u0441\u043A\u043B\u0430\u0434\u0435" }), _jsx(Text, { fw: 700, size: "xl", c: "orange", children: formatCurrency(equity.inventoryAssets) })] }) }) })] }), _jsxs(Paper, { withBorder: true, p: "md", radius: "md", mb: "xl", children: [_jsx(Group, { justify: "space-between", mb: "md", children: _jsxs("div", { children: [_jsx(Text, { fw: 600, size: "lg", children: "\u0412\u043B\u0430\u0434\u0435\u043B\u044C\u0446\u044B \u0431\u0438\u0437\u043D\u0435\u0441\u0430" }), _jsxs(Text, { c: "dimmed", size: "sm", children: ["\u0412\u0441\u0435\u0433\u043E \u0432\u043B\u0430\u0434\u0435\u043B\u044C\u0446\u0435\u0432: ", equity.ownersCount] })] }) }), _jsx(Divider, { mb: "md" }), equity.owners.length > 0 ? (_jsxs(Stack, { gap: "xl", children: [equity.owners.map((owner) => {
                                const investments = parseFloat(owner.totalInvestments);
                                const revenueShare = parseFloat(owner.equityValue); // Доля выручки
                                const withdrawals = parseFloat(owner.totalWithdrawals);
                                const availableCash = parseFloat(owner.availableCash); // Чистая прибыль
                                // Текущий баланс = Вложения + Чистая прибыль
                                const currentBalance = investments + availableCash;
                                const chartData = [
                                    {
                                        name: owner.fullName,
                                        'Вложения': investments,
                                        'Доля выручки': revenueShare,
                                        'Изъятия': withdrawals,
                                        'Чистая прибыль': availableCash,
                                    },
                                ];
                                return (_jsxs(Paper, { withBorder: true, p: "md", radius: "md", children: [_jsxs(Group, { justify: "space-between", mb: "md", children: [_jsxs("div", { children: [_jsx(Text, { fw: 600, size: "lg", children: owner.fullName }), _jsx(Text, { c: "dimmed", size: "sm", children: owner.email })] }), _jsxs("div", { style: { textAlign: 'right' }, children: [_jsx(Text, { c: "dimmed", size: "xs", tt: "uppercase", fw: 700, mb: 4, children: "\u0422\u0435\u043A\u0443\u0449\u0438\u0439 \u0431\u0430\u043B\u0430\u043D\u0441:" }), _jsx(Text, { fw: 700, size: "xl", c: "orange", children: formatCurrency(currentBalance.toFixed(2)) }), _jsxs(Badge, { variant: "light", color: "greenCycle", size: "lg", mt: "xs", children: [owner.share.toFixed(2), "%"] })] })] }), _jsx(SimpleBarChart, { data: chartData, xKey: "name", height: 300, margin: { top: 20, right: 30, left: 20, bottom: 20 }, bars: [
                                                { key: 'Вложения', color: '#9333ea' },
                                                { key: 'Доля выручки', color: '#339af0' },
                                                { key: 'Изъятия', color: '#ff6b6b' },
                                                { key: 'Чистая прибыль', color: '#40c057' },
                                            ], yAxisTickFormatter: (value) => {
                                                if (value >= 1000000) {
                                                    return `${(value / 1000000).toFixed(1)}M`;
                                                }
                                                if (value >= 1000) {
                                                    return `${(value / 1000).toFixed(0)}K`;
                                                }
                                                return value.toString();
                                            }, tooltipFormatter: (value, name) => [
                                                formatCurrency(String(value)),
                                                name,
                                            ], labelFormatter: () => owner.fullName }), _jsxs(SimpleGrid, { cols: { base: 1, sm: 4 }, spacing: "md", mt: "md", children: [_jsxs("div", { children: [_jsx(Text, { c: "dimmed", size: "xs", tt: "uppercase", fw: 700, children: "\u0412\u043B\u043E\u0436\u0435\u043D\u0438\u044F" }), _jsx(Text, { fw: 600, size: "lg", style: { color: '#9333ea' }, children: formatCurrency(owner.totalInvestments) })] }), _jsxs("div", { children: [_jsx(Text, { c: "dimmed", size: "xs", tt: "uppercase", fw: 700, children: "\u0414\u043E\u043B\u044F \u0432\u044B\u0440\u0443\u0447\u043A\u0438" }), _jsx(Text, { fw: 600, size: "lg", c: "blue", children: formatCurrency(owner.equityValue) })] }), _jsxs("div", { children: [_jsx(Text, { c: "dimmed", size: "xs", tt: "uppercase", fw: 700, children: "\u0418\u0437\u044A\u044F\u0442\u0438\u044F" }), _jsx(Text, { fw: 600, size: "lg", c: "red", children: formatCurrency(owner.totalWithdrawals) })] }), _jsxs("div", { children: [_jsx(Text, { c: "dimmed", size: "xs", tt: "uppercase", fw: 700, children: "\u0427\u0438\u0441\u0442\u0430\u044F \u043F\u0440\u0438\u0431\u044B\u043B\u044C" }), _jsx(Text, { fw: 600, size: "lg", c: "greenCycle", children: formatCurrency(owner.availableCash) })] })] })] }, owner.userId));
                            }), _jsxs(Paper, { withBorder: true, p: "md", radius: "md", mt: "md", style: { backgroundColor: 'var(--mantine-color-gray-0)' }, children: [_jsx(Text, { fw: 700, size: "sm", mb: "md", c: "dimmed", children: "\u0424\u043E\u0440\u043C\u0443\u043B\u044B \u0440\u0430\u0441\u0447\u0435\u0442\u043E\u0432 (\u0434\u0435\u043C\u043E-\u0434\u0430\u043D\u043D\u044B\u0435)" }), (() => {
                                        const demoInvestments = 1200000;
                                        const demoShare = 40;
                                        const demoRevenue = 5000000;
                                        const demoExpenses = 750000;
                                        const demoWithdrawals = 300000;
                                        const demoRevenueShare = ((demoRevenue - demoExpenses) * demoShare) / 100;
                                        const demoNetProfit = demoRevenueShare - demoWithdrawals - demoInvestments;
                                        const demoBalance = demoInvestments + demoNetProfit;
                                        return (_jsxs(SimpleGrid, { cols: { base: 1, sm: 2 }, children: [_jsxs(Stack, { gap: "sm", children: [_jsx(Text, { fw: 600, size: "sm", style: { color: '#9333ea' }, children: "\u0412\u043B\u043E\u0436\u0435\u043D\u0438\u044F" }), _jsx(Text, { size: "xs", c: "dimmed", children: "\u041F\u0440\u044F\u043C\u044B\u0435 \u043F\u043E\u043F\u043E\u043B\u043D\u0435\u043D\u0438\u044F + \u0438\u043D\u0432\u0435\u0441\u0442\u0438\u0446\u0438\u0438 \u0432 \u043F\u043E\u0441\u0442\u0430\u0432\u043A\u0438" }), _jsxs(Text, { size: "xs", style: { fontFamily: 'monospace', backgroundColor: 'white', padding: '4px 8px', borderRadius: '4px' }, children: ["1) \u0412\u043B\u043E\u0436\u0435\u043D\u0438\u044F = ", formatCurrency(demoInvestments.toFixed(2))] }), _jsx(Text, { fw: 600, size: "sm", mt: "md", style: { color: '#339af0' }, children: "\u0414\u043E\u043B\u044F \u0432\u044B\u0440\u0443\u0447\u043A\u0438" }), _jsx(Text, { size: "xs", c: "dimmed", children: "(\u041E\u0431\u0449\u0430\u044F \u0432\u044B\u0440\u0443\u0447\u043A\u0430 - \u041E\u0431\u0449\u0438\u0435 \u0440\u0430\u0441\u0445\u043E\u0434\u044B) \u00D7 \u0414\u043E\u043B\u044F" }), _jsxs(Text, { size: "xs", style: { fontFamily: 'monospace', backgroundColor: 'white', padding: '4px 8px', borderRadius: '4px' }, children: ["2) (", formatCurrency(demoRevenue.toFixed(2)), " - ", formatCurrency(demoExpenses.toFixed(2)), ") \u00D7 ", demoShare, "% =", ' ', formatCurrency(demoRevenueShare.toFixed(2))] })] }), _jsxs(Stack, { gap: "sm", children: [_jsx(Text, { fw: 600, size: "sm", style: { color: '#40c057' }, children: "\u0427\u0438\u0441\u0442\u0430\u044F \u043F\u0440\u0438\u0431\u044B\u043B\u044C" }), _jsx(Text, { size: "xs", c: "dimmed", children: "\u0414\u043E\u043B\u044F \u0432\u044B\u0440\u0443\u0447\u043A\u0438 - \u0418\u0437\u044A\u044F\u0442\u0438\u044F - \u0412\u043B\u043E\u0436\u0435\u043D\u0438\u044F" }), _jsxs(Text, { size: "xs", style: { fontFamily: 'monospace', backgroundColor: 'white', padding: '4px 8px', borderRadius: '4px' }, children: ["3) ", formatCurrency(demoRevenueShare.toFixed(2)), " - ", formatCurrency(demoWithdrawals.toFixed(2)), " -", ' ', formatCurrency(demoInvestments.toFixed(2)), " = ", formatCurrency(demoNetProfit.toFixed(2))] }), _jsx(Text, { fw: 600, size: "sm", mt: "md", style: { color: '#fd7e14' }, children: "\u0422\u0435\u043A\u0443\u0449\u0438\u0439 \u0431\u0430\u043B\u0430\u043D\u0441" }), _jsx(Text, { size: "xs", c: "dimmed", children: "\u0412\u043B\u043E\u0436\u0435\u043D\u0438\u044F + \u0427\u0438\u0441\u0442\u0430\u044F \u043F\u0440\u0438\u0431\u044B\u043B\u044C" }), _jsxs(Text, { size: "xs", style: { fontFamily: 'monospace', backgroundColor: 'white', padding: '4px 8px', borderRadius: '4px' }, children: ["4) ", formatCurrency(demoInvestments.toFixed(2)), " + ", formatCurrency(demoNetProfit.toFixed(2)), " =", ' ', formatCurrency(demoBalance.toFixed(2))] })] })] }));
                                    })()] })] })) : (_jsx(Text, { c: "dimmed", ta: "center", py: "md", children: "\u041D\u0435\u0442 \u0432\u043B\u0430\u0434\u0435\u043B\u044C\u0446\u0435\u0432 \u0431\u0438\u0437\u043D\u0435\u0441\u0430" }))] }), _jsxs(Paper, { withBorder: true, p: "md", radius: "md", children: [_jsx(Text, { fw: 600, size: "lg", mb: "md", children: "\u0414\u0435\u0442\u0430\u043B\u044C\u043D\u0430\u044F \u0438\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u044F" }), _jsxs(Table, { striped: true, highlightOnHover: true, children: [_jsx(Table.Thead, { children: _jsxs(Table.Tr, { children: [_jsx(Table.Th, { children: "\u0412\u043B\u0430\u0434\u0435\u043B\u0435\u0446" }), _jsx(Table.Th, { children: "\u0414\u043E\u043B\u044F, %" }), _jsx(Table.Th, { children: "\u0412\u043B\u043E\u0436\u0435\u043D\u0438\u044F" }), _jsx(Table.Th, { children: "\u0414\u043E\u043B\u044F \u0432\u044B\u0440\u0443\u0447\u043A\u0438" }), _jsx(Table.Th, { children: "\u0427\u0438\u0441\u0442\u0430\u044F \u043F\u0440\u0438\u0431\u044B\u043B\u044C" }), _jsx(Table.Th, { children: "\u0414\u0435\u043D\u0435\u0436\u043D\u044B\u0435 \u0438\u0437\u044A\u044F\u0442\u0438\u044F" }), _jsx(Table.Th, { children: "\u0411\u0430\u043B\u0430\u043D\u0441 \u0441\u0440\u0435\u0434\u0441\u0442\u0432" })] }) }), _jsx(Table.Tbody, { children: equity.owners.map((owner) => {
                                    const investments = parseFloat(owner.totalInvestments);
                                    const availableCash = parseFloat(owner.availableCash);
                                    const currentBalance = investments + availableCash;
                                    return (_jsxs(Table.Tr, { children: [_jsxs(Table.Td, { children: [_jsx(Text, { fw: 600, children: owner.fullName }), _jsx(Text, { c: "dimmed", size: "sm", children: owner.email })] }), _jsx(Table.Td, { children: _jsxs(Badge, { variant: "light", color: "greenCycle", children: [owner.share.toFixed(2), "%"] }) }), _jsx(Table.Td, { children: _jsx(Text, { fw: 600, style: { color: '#9333ea' }, children: formatCurrency(owner.totalInvestments) }) }), _jsx(Table.Td, { children: _jsx(Text, { fw: 600, style: { color: '#339af0' }, children: formatCurrency(owner.equityValue) }) }), _jsx(Table.Td, { children: _jsx(Text, { fw: 700, style: { color: '#40c057' }, children: formatCurrency(owner.availableCash) }) }), _jsx(Table.Td, { children: _jsx(Text, { fw: 600, style: { color: '#ff6b6b' }, children: formatCurrency(owner.totalWithdrawals) }) }), _jsx(Table.Td, { children: _jsx(Text, { fw: 700, c: "orange", children: formatCurrency(currentBalance.toFixed(2)) }) })] }, owner.userId));
                                }) })] })] })] }));
}
