# Фаза 4 — Бэкенд: доменные модули (часть 1)

## 1. Поставщики и поставки
- Добавлен модуль `SuppliersModule`:
  - CRUD-эндпоинты `/suppliers` с поиском, валидацией DTO и проверкой ролей.
  - Сущность `Supplier` (уникальное имя, контактная информация, аудит).
- Добавлен модуль `ShipmentsModule`:
  - `POST /shipments` создаёт поставку и связанные партии; автоматически считает `totalCost`.
  - `GET /shipments` и `GET /shipments/:id` возвращают поставки с партиями.
  - DTO покрывают структуру партий (`plantType`, размеры, potType, количество, закупочная цена).
- Сущности `Shipment` и `Batch` со связями, каскадным удалением и полями аудита.

## 2. Склад и списания
- Добавлен `InventoryModule`:
  - `GET /inventory` — сводка по остаткам (партии, поставки, поставщики).
  - `POST /inventory/write-offs` — оформляет списание, контролирует остатки.
  - `GET /inventory/write-offs` — журнал списаний.
- Сущность `WriteOff` хранит причину, дату, количество и общую стоимость на момент списания.
- Все операции выполняются в транзакции, `quantityCurrent` корректируется, стоимость вычисляется по закупочной цене партии.

## 3. Клиенты (CRM)
- Добавлен `ClientsModule`:
  - CRUD-эндпоинты `/clients` с поиском по имени, телефону, email.
  - Сущность `Client` с полями: ФИО, телефон, email, адрес, тип (individual/wholesaler), дата первой покупки.
  - Индексы на `phone` и `email` для быстрого поиска.
  - Методы `findByPhone` и `findByEmail` для поиска при создании продаж.
  - Метод `updateFirstPurchaseDate` для автоматического обновления даты первой покупки.

## 4. Миграции
- Миграция `1731406000000-CreateSuppliersShipmentsBatches` создаёт таблицы:
  - `suppliers` (уникальное имя, контактная информация),
  - `shipments` (датa поставки, сумма, ссылка на поставщика, документ),
  - `batches` (характеристики партий, остатки, закупочная цена).
- Миграция `1731407000000-CreateWriteOffs` создаёт таблицу:
  - `write_offs` (причина, дата, количество, стоимость, комментарий).
- Миграция `1731408000000-CreateClients` создаёт таблицу:
  - `clients` (ФИО, телефон, email, адрес, тип клиента, дата первой покупки, аудит).
- Добавлены индексы для быстрых выборок и частичные индексы для не-null значений.

## 5. Интеграция
- `AppModule` теперь импортирует `SuppliersModule`, `ShipmentsModule`, `InventoryModule` и `ClientsModule`.
- Модули используют существующие guard'ы и контекст аудита.
- Все новые сервисы и контроллеры проходят существующий ESLint + TypeScript проверки.

## 6. Продажи
- Добавлен `SalesModule`:
  - `POST /sales` — создаёт продажу с привязкой к клиенту и партиям, уменьшает остатки в транзакции.
  - `GET /sales` и `GET /sales/:id` — возвращают продажи с клиентами и позициями.
  - `PATCH /sales/:id/cancel` — отменяет продажу и возвращает остатки на склад.
- Сущности `Sale` и `SaleItem` со связями и статусами (completed/cancelled).
- Автоматическое обновление `firstPurchaseDate` у клиента при первой покупке.
- Автоматический расчёт `totalAmount` на основе позиций продажи.
- Транзакционная логика: проверка остатков, блокировка партий, атомарное сохранение.

## 7. Миграции
- Миграция `1731409000000-CreateSales` создаёт таблицы:
  - `sales` (клиент, дата, сумма, статус, аудит),
  - `sale_items` (продажа, партия, количество, цена продажи за единицу).
- Добавлены индексы по `sale_date`, `client_id`, `sale_id`, `batch_id`.

## 8. Интеграция
- `AppModule` теперь импортирует `SalesModule`.
- Модуль использует `ClientsModule` и `ShipmentsModule` (Batch).
- Все операции выполняются в транзакциях с блокировками для целостности данных.

## 10. Выкуп
- Добавлен `BuybacksModule`:
  - `POST /buybacks` — создаёт выкуп с привязкой к продаже и клиенту, проверяет соответствие клиентов.
  - `GET /buybacks` и `GET /buybacks/:id` — возвращают выкупы с продажами, клиентами и позициями.
  - `PATCH /buybacks/:id` — обновляет даты, статус и заметки выкупа.
  - `PATCH /buybacks/:id/complete` — завершает выкуп и возвращает товар на склад (увеличивает `quantityCurrent`).
  - `PATCH /buybacks/:id/decline` — отменяет выкуп.
- Сущности `Buyback` и `BuybackItem` со связями и статусами (planned, contacted, declined, completed).
- Связь с оригинальной продажей через `original_sale_id` и `original_sale_item_id`.
- Транзакционная логика при завершении выкупа: возврат товара на склад с блокировкой партий.
- Валидация: проверка соответствия клиентов, количества выкупа не превышает количество в продаже.

## 11. Миграции
- Миграция `1731410000000-CreateBuybacks` создаёт таблицы:
  - `buybacks` (продажа, клиент, планируемая дата, фактическая дата, статус, заметки, аудит),
  - `buyback_items` (выкуп, позиция продажи, количество, цена выкупа за единицу, примечания о состоянии).
- Добавлены индексы по `planned_date`, `status`, `client_id`, `buyback_id`, `original_sale_item_id`.

## 12. Интеграция
- `AppModule` теперь импортирует `BuybacksModule`.
- Модуль использует `SalesModule`, `ClientsModule` и `ShipmentsModule` (Batch).
- Все операции выполняются в транзакциях с блокировками для целостности данных.

## 14. Финансы
- Добавлен `FinanceModule`:
  - **Accounts (счета)**:
    - `POST /finance/accounts` — создаёт счёт (cash, bank, other).
    - `GET /finance/accounts` и `GET /finance/accounts/:id` — возвращают счета с балансами.
    - `PATCH /finance/accounts/:id` — обновляет счёт.
    - `DELETE /finance/accounts/:id` — удаляет счёт (только без транзакций).
    - `POST /finance/accounts/:id/recalculate` — пересчитывает баланс счёта.
  - **Transactions (транзакции)**:
    - `POST /finance/transactions` — создаёт транзакцию и автоматически обновляет баланс счёта.
    - `GET /finance/transactions` и `GET /finance/transactions/:id` — возвращают транзакции.
    - `DELETE /finance/transactions/:id` — удаляет транзакцию и пересчитывает баланс.
    - Типы транзакций: purchase, sale, buyback, write_off, partner_withdrawal.
    - Связь с сущностями через `linked_entity_id` и `linked_entity_type`.
  - **Partner Withdrawals (изъятия партнёров)**:
    - `POST /finance/partner-withdrawals` — создаёт изъятие партнёра (только для админов).
    - `GET /finance/partner-withdrawals` и `GET /finance/partner-withdrawals/:id` — возвращают изъятия.
    - Типы изъятий: cash (создаёт транзакцию) и goods (по себестоимости).
    - Автоматическое создание транзакции при изъятии денег.
- Сущности `Account`, `Transaction`, `PartnerWithdrawal` со связями и аудитом.
- Автоматический расчёт балансов: баланс счёта обновляется при создании/удалении транзакций.
- Транзакционная логика: все операции выполняются в транзакциях с блокировками.

## 15. Миграции
- Миграция `1731411000000-CreateFinance` создаёт таблицы:
  - `accounts` (название, тип, баланс),
  - `transactions` (счёт, сумма, тип, описание, связанная сущность, аудит),
  - `partner_withdrawals` (пользователь, тип, сумма/количество, стоимость, причина, аудит).
- Добавлены индексы по `account_id`, `type`, `linked_entity`, `user_id`, `created_at`.

## 16. Интеграция
- `AppModule` теперь импортирует `FinanceModule`.
- Модуль использует `UsersModule` для проверки ролей партнёров.
- Все операции выполняются в транзакциях с блокировками для целостности данных.

## 18. Уведомления
- Добавлен `NotificationsModule`:
  - `POST /notifications` — создаёт уведомление для пользователя.
  - `GET /notifications` — возвращает уведомления (с фильтрацией по userId, isRead).
  - `GET /notifications/my` — возвращает уведомления текущего пользователя.
  - `GET /notifications/upcoming` — возвращает предстоящие уведомления (по умолчанию 30 дней).
  - `GET /notifications/unread-count` — возвращает количество непрочитанных уведомлений.
  - `GET /notifications/:id` — возвращает уведомление по ID.
  - `PATCH /notifications/:id` — обновляет уведомление.
  - `PATCH /notifications/:id/read` — помечает уведомление как прочитанное.
  - `PATCH /notifications/read-all` — помечает все уведомления пользователя как прочитанные.
  - `DELETE /notifications/:id` — удаляет уведомление.
- Сущность `Notification` с полями: пользователь, клиент (опционально), выкуп (опционально), сообщение, статус прочтения, дата напоминания.
- Автоматическое создание уведомлений для выкупов:
  - При создании выкупа создаются уведомления за 60, 30 и 7 дней до `planned_date`.
  - Уведомления создаются для всех админов, супер-админов и менеджеров с информацией о предстоящем выкупе.
  - Метод `createBuybackReminders` автоматически рассчитывает даты напоминаний и создаёт уведомления для каждого пользователя с соответствующей ролью.
  - Уведомления не дублируются: проверяется существование уведомления для пользователя, выкупа и даты напоминания.
- Индексы по `user_id`, `is_read`, `buyback_id`, `due_date` для быстрых выборок.

## 19. Миграции
- Миграция `1731412000000-CreateNotifications` создаёт таблицу:
  - `notifications` (пользователь, клиент, выкуп, сообщение, статус прочтения, дата напоминания).
- Добавлены индексы по `user_id`, `is_read`, `buyback_id`, `due_date`.

## 20. Интеграция
- `AppModule` теперь импортирует `NotificationsModule`.
- Модуль использует `UsersModule`, `ClientsModule` и `BuybacksModule`.
- `BuybacksModule` использует `NotificationsModule` для автоматического создания уведомлений при создании выкупа (через `forwardRef` для избежания циклических зависимостей).
- Все операции выполняются в транзакциях с блокировками для целостности данных.

## 22. Отчёты и аналитика
- Добавлен `ReportsModule`:
  - `GET /reports/profit-by-shipment` — прибыль по поставкам (фильтрация по дате, поставке).
  - `GET /reports/profit-by-client` — прибыль по клиентам (фильтрация по дате, клиенту).
  - `GET /reports/buyback-forecast` — прогноз выкупа (объём, потенциальная маржа, статус).
  - `GET /reports/cash-flow` — движение денежных средств (фильтрация по дате, счёту).
  - `GET /reports/client-activity` — активность клиентов (даты покупок, количество, выручка, выкупы).
  - `GET /reports/inventory-summary` — сводка по остаткам на складе (аналогично `/inventory`).
- Все отчёты строятся динамически через агрегацию данных из существующих таблиц.
- Фильтрация по датам, клиентам, поставкам, счетам через query parameters.
- Автоматический расчёт прибыли, маржи, прогнозов на основе закупочных и продажных цен.
- Использование QueryBuilder для сложных запросов с агрегацией и группировкой.
- Типизированные типы для результатов отчётов (ProfitReportItem, ClientProfitReportItem, BuybackForecastItem, CashFlowItem, ClientActivityItem).

## 23. Интеграция
- `AppModule` теперь импортирует `ReportsModule`.
- Модуль использует все доменные модули (Sales, Buybacks, Shipments, Clients, Finance, Inventory).
- Все отчёты доступны для админов, супер-админов, бухгалтеров и менеджеров (в зависимости от типа отчёта).

## 24. Следующие шаги
- Расширить отчётность: добавить параметрический конструктор отчётов (выбор полей, группировка, агрегация).
- Добавить транзакционную интеграцию с финансовым модулем (автоматическое создание транзакций при покупке, продаже, выкупе, списании).
- Реализовать автоматическое создание задач на выкуп через 3–4 года после продажи.
- Реализовать email-уведомления через Nodemailer (Фаза 7).
- Добавить экспорт отчётов в PDF и Excel (Фаза 7).

